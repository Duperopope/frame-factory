<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warframe Build Optimizer - Version Finale Améliorée V39</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dark-mode {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --text-primary: #e94560;
            --text-secondary: #f5f5f5;
            --accent: #e94560;
            --border: #16213e;
        }
        
        .light-mode {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --accent: #e94560;
            --border: #e2e8f0;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .bg-primary { background: var(--bg-primary); }
        .bg-secondary { background: var(--bg-secondary); }
        .bg-tertiary { background: var(--bg-tertiary); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-custom { border-color: var(--border); }

        .tab-button {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px rgba(233, 69, 96, 0.3);
        }

        .item-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .item-card:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(233, 69, 96, 0.2);
        }

        .infinite-scroll {
            max-height: 70vh;
            overflow-y: auto;
        }

        .number-display {
            font-family: 'Courier New', monospace;
            background: var(--bg-tertiary);
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }

        .progress-container {
            background: var(--bg-tertiary);
            border-radius: 1rem;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--accent), #ff6b8a);
            transition: width 0.3s ease;
            height: 100%;
        }

        .placeholder-image {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--border));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .loading-spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .eta-display {
            background: var(--bg-secondary);
            border: 1px solid var(--accent);
            color: var(--accent);
        }
    </style>
</head>
<body class="light-mode">
    <div class="min-h-screen bg-primary">
        <!-- Header -->
        <header class="bg-secondary border-b border-custom shadow-lg">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-cogs text-primary text-2xl"></i>
                        <h1 class="text-2xl font-bold text-primary" data-i18n="app_title">Warframe Build Optimizer</h1>
                        <span class="text-sm bg-tertiary px-3 py-1 rounded-full" data-i18n="app_version">v39 Isleweaver</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <select id="languageSelect" class="bg-secondary border border-custom px-3 py-2 rounded-lg text-secondary" data-i18n-title="select_language">
                            <option value="en">English</option>
                            <option value="fr">Français</option>
                            <option value="de">Deutsch</option>
                            <option value="es">Español</option>
                            <option value="it">Italiano</option>
                            <option value="ko">한국어</option>
                            <option value="pl">Polski</option>
                            <option value="pt">Português</option>
                            <option value="ru">Русский</option>
                            <option value="zh">中文</option>
                            <option value="uk">Українська</option>
                        </select>
                        <div id="apiStatus" class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                            <span class="text-sm" data-i18n="api_connected">API Connected</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-secondary border-b border-custom">
            <div class="container mx-auto px-6">
                <div class="flex space-x-1 overflow-x-auto">
                    <button class="tab-button active px-6 py-3 rounded-t-lg" data-tab="optimizer" data-i18n="optimizer" data-i18n-title="desc_optimizer">
                        <i class="fas fa-search mr-2"></i><span data-i18n="optimizer"></span>
                    </button>
                    <button class="tab-button px-6 py-3 rounded-t-lg" data-tab="codex" data-i18n="codex" data-i18n-title="desc_codex">
                        <i class="fas fa-book mr-2"></i><span data-i18n="codex"></span>
                    </button>
                    <button class="tab-button px-6 py-3 rounded-t-lg" data-tab="leaderboard" data-i18n="leaderboard" data-i18n-title="desc_leaderboard">
                        <i class="fas fa-trophy mr-2"></i><span data-i18n="leaderboard"></span>
                    </button>
                    <button class="tab-button px-6 py-3 rounded-t-lg" data-tab="builder" data-i18n="builder" data-i18n-title="desc_builder">
                        <i class="fas fa-hammer mr-2"></i><span data-i18n="builder"></span>
                    </button>
                    <button class="tab-button px-6 py-3 rounded-t-lg" data-tab="settings" data-i18n="settings" data-i18n-title="desc_settings">
                        <i class="fas fa-cog mr-2"></i><span data-i18n="settings"></span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Content -->
        <main class="container mx-auto px-6 py-8">
            <!-- Optimizer Tab -->
            <div id="optimizer" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Optimization Controls -->
                    <div class="lg:col-span-1">
                        <div class="bg-secondary rounded-xl border border-custom p-6 mb-6">
                            <h2 class="text-xl font-bold text-primary mb-4" data-i18n="optimization_parameters">Optimization Parameters</h2>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2" data-i18n="content_type">Content Type</label>
                                    <select id="contentType" class="w-full bg-tertiary border border-custom px-3 py-2 rounded-lg"></select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-2" data-i18n="enemy_level">Enemy Level</label>
                                    <input type="range" id="enemyLevel" min="1" max="9999" value="150" class="w-full">
                                    <span id="enemyLevelDisplay" class="text-sm text-secondary">Level: 150</span>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-2" data-i18n="target_faction">Target Faction</label>
                                    <select id="targetFaction" class="w-full bg-tertiary border border-custom px-3 py-2 rounded-lg"></select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-2" data-i18n="optimization_seed">Optimization Seed</label>
                                    <div class="flex space-x-2">
                                        <input type="text" id="optimizationSeed" placeholder="Random seed..." class="flex-1 bg-tertiary border border-custom px-3 py-2 rounded-lg">
                                        <button id="randomSeed" class="bg-accent text-white px-3 py-2 rounded-lg hover:bg-opacity-80" data-i18n-title="desc_random_seed">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <button id="startOptimization" class="w-full bg-accent text-white py-3 rounded-lg hover:bg-opacity-80 transition-colors" data-i18n="start_optimization" data-i18n-title="desc_start_optimization">
                                        <i class="fas fa-play mr-2"></i><span data-i18n="start_optimization"></span>
                                    </button>
                                    <button id="parallelSearch" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-opacity-80 transition-colors" data-i18n="parallel_search" data-i18n-title="desc_parallel_search">
                                        <i class="fas fa-rocket mr-2"></i><span data-i18n="parallel_search"></span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Statistics -->
                        <div class="bg-secondary rounded-xl border border-custom p-6">
                            <h3 class="text-lg font-bold text-primary mb-4" data-i18n="statistics">Statistics</h3>
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm" data-i18n="total_combinations">Total Combinations</span>
                                    <div id="totalCombinations" class="number-display text-lg font-mono">
                                        Calculating...
                                    </div>
                                </div>
                                <div>
                                    <span class="text-sm" data-i18n="tested_combinations">Tested Combinations</span>
                                    <div id="testedCombinations" class="number-display text-lg font-mono">
                                        0
                                    </div>
                                </div>
                                <div>
                                    <span class="text-sm" data-i18n="progress">Progress</span>
                                    <div class="progress-container h-4 mt-2">
                                        <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                                    </div>
                                    <div id="progressPercent" class="text-sm mt-1">0%</div>
                                </div>
                                <div>
                                    <span class="text-sm" data-i18n="eta">ETA</span>
                                    <div id="etaDisplay" class="eta-display px-3 py-2 rounded-lg text-center font-mono">
                                        --:--:--
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Results -->
                    <div class="lg:col-span-2">
                        <div class="bg-secondary rounded-xl border border-custom p-6">
                            <h2 class="text-xl font-bold text-primary mb-4">
                                <i class="fas fa-chart-line mr-2"></i>Optimization Results
                            </h2>
                            
                            <div id="optimizationResults" class="space-y-4">
                                <div class="text-center py-12 text-secondary">
                                    <i class="fas fa-search text-4xl mb-4 opacity-50"></i>
                                    <p>Click "Start Optimization" to begin finding the best builds</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Codex Tab -->
            <div id="codex" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- Category Sidebar -->
                    <div class="lg:col-span-1">
                        <div class="bg-secondary rounded-xl border border-custom p-6 sticky top-4">
                            <h2 class="text-xl font-bold text-primary mb-4">Categories</h2>
                            <div class="space-y-2">
                                <button class="category-btn w-full text-left px-3 py-2 rounded-lg bg-accent text-white" data-category="warframes">
                                    <i class="fas fa-user-astronaut mr-2"></i>Warframes <span id="warframes-count" class="float-right">0</span>
                                </button>
                                <button class="category-btn w-full text-left px-3 py-2 rounded-lg hover:bg-tertiary" data-category="primary">
                                    <i class="fas fa-crosshairs mr-2"></i>Primary <span id="primary-count" class="float-right">0</span>
                                </button>
                                <button class="category-btn w-full text-left px-3 py-2 rounded-lg hover:bg-tertiary" data-category="secondary">
                                    <i class="fas fa-gun mr-2"></i>Secondary <span id="secondary-count" class="float-right">0</span>
                                </button>
                                <button class="category-btn w-full text-left px-3 py-2 rounded-lg hover:bg-tertiary" data-category="melee">
                                    <i class="fas fa-sword mr-2"></i>Melee <span id="melee-count" class="float-right">0</span>
                                </button>
                                <button class="category-btn w-full text-left px-3 py-2 rounded-lg hover:bg-tertiary" data-category="mods">
                                    <i class="fas fa-puzzle-piece mr-2"></i>Mods <span id="mods-count" class="float-right">0</span>
                                </button>
                                <button class="category-btn w-full text-left px-3 py-2 rounded-lg hover:bg-tertiary" data-category="arcanes">
                                    <i class="fas fa-gem mr-2"></i>Arcanes <span id="arcanes-count" class="float-right">0</span>
                                </button>
                                <button class="category-btn w-full text-left px-3 py-2 rounded-lg hover:bg-tertiary" data-category="misc">
                                    <i class="fas fa-box mr-2"></i>Misc <span id="misc-count" class="float-right">0</span>
                                </button>
                            </div>
                            
                            <div class="mt-6">
                                <label class="block text-sm font-medium mb-2">Search</label>
                                <input type="text" id="searchInput" placeholder="Search items..." class="w-full bg-tertiary border border-custom px-3 py-2 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <!-- Items Grid -->
                    <div class="lg:col-span-3">
                        <div class="bg-secondary rounded-xl border border-custom p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-xl font-bold text-primary">
                                    <span id="currentCategoryTitle" data-i18n-title></span>
                                </h2>
                                <div id="loadingSpinner" class="loading-spinner w-6 h-6 rounded-full hidden"></div>
                            </div>
                            
                            <div id="itemsGrid" class="infinite-scroll">
                                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="itemsContainer">
                                    <!-- Items will be populated dynamically -->
                                </div>
                                <div id="loadMoreTrigger" class="h-20 flex items-center justify-center">
                                    <div class="loading-spinner w-8 h-8 rounded-full hidden"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Tab -->
            <div id="leaderboard" class="tab-content hidden">
                <div class="bg-secondary rounded-xl border border-custom p-6">
                    <h2 class="text-xl font-bold text-primary mb-6">
                        <i class="fas fa-trophy mr-2"></i>Top 100 Builds
                    </h2>
                    
                    <div id="leaderboardList" class="space-y-4">
                        <div class="text-center py-12 text-secondary">
                            <i class="fas fa-trophy text-4xl mb-4 opacity-50"></i>
                            <p>No builds in leaderboard yet. Run optimizations to see results here.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Builder Tab -->
            <div id="builder" class="tab-content hidden">
                <div class="bg-secondary rounded-xl border border-custom p-6">
                    <h2 class="text-xl font-bold text-primary mb-6">
                        <i class="fas fa-hammer mr-2"></i>Custom Build Creator
                    </h2>
                    
                    <div class="text-center py-12 text-secondary">
                        <i class="fas fa-hammer text-4xl mb-4 opacity-50"></i>
                        <p>Custom builder interface coming soon...</p>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content hidden">
                <div class="bg-secondary rounded-xl border border-custom p-6">
                    <h2 class="text-xl font-bold text-primary mb-6">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Appearance</h3>
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center space-x-2">
                                    <input type="radio" name="theme" value="light" id="lightTheme" class="form-radio">
                                    <span>Light Mode</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="radio" name="theme" value="dark" id="darkTheme" class="form-radio">
                                    <span>Dark Mode</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold mb-3">Optimization</h3>
                            <div class="space-y-3">
                                <label class="block">
                                    <span class="text-sm">Max Parallel Workers</span>
                                    <input type="number" id="maxWorkers" min="1" max="16" value="4" class="w-full bg-tertiary border border-custom px-3 py-2 rounded-lg mt-1">
                                </label>
                                <label class="block">
                                    <span class="text-sm">Cache Size (MB)</span>
                                    <input type="number" id="cacheSize" min="10" max="1000" value="100" class="w-full bg-tertiary border border-custom px-3 py-2 rounded-lg mt-1">
                                </label>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold mb-3">Data Sources</h3>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span>API Status</span>
                                    <span class="text-green-500">Connected</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span>Last Update</span>
                                    <span id="lastUpdate">Never</span>
                                </div>
                                <button id="refreshData" class="bg-accent text-white px-4 py-2 rounded-lg hover:bg-opacity-80">
                                    <i class="fas fa-sync mr-2"></i>Refresh Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Global state
        let currentLanguage = 'en';
        let currentTheme = 'light';
        let allItems = [];
        let currentCategory = 'warframes';
        let currentItems = [];
        let displayedItems = 0;
        let itemsPerPage = 30;
        let optimizationWorker = null;
        let isOptimizing = false;
        let optimizationStartTime = 0;
        let totalCombinations = 0;
        let testedCombinations = 0;

        // Gestion des traductions dynamiques
        let currentTranslations = {};

        async function loadTranslations(language) {
            try {
                const response = await fetch(`locales/${language}.json`);
                if (!response.ok) throw new Error('Translation file not found');
                currentTranslations = await response.json();
            } catch (e) {
                // Fallback anglais si la langue n'existe pas
                const response = await fetch('locales/en.json');
                currentTranslations = await response.json();
            }
        }

        function updateStaticTexts() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (currentTranslations && currentTranslations[key] && el) {
                    el.textContent = currentTranslations[key];
                }
            });
            // Tooltips dynamiques pour les titres et boutons
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                let key = el.getAttribute('data-i18n-title');
                // Pour le titre de catégorie, on adapte dynamiquement
                if (el.id === 'currentCategoryTitle' && typeof currentCategory === 'string') {
                    key = 'category_' + currentCategory;
                }
                if (currentTranslations && currentTranslations[key] && el) {
                    el.title = currentTranslations[key];
                }
            });
            // Pour ajouter d'autres textes traduits, il suffit d'ajouter data-i18n="clé" ou data-i18n-title="clé" sur l'élément HTML correspondant
        }

        // API Manager
        class WarframeAPI {
            constructor() {
                this.baseURL = 'https://api.warframestat.us';
                this.cdnURL = 'https://cdn.warframestat.us/img';
                this.cache = new Map();
            }

            async fetchAllItems(language = 'en') {
                const cacheKey = 'allItems-' + language;
                if (this.cache.has(cacheKey)) {
                    return this.cache.get(cacheKey);
                }
                try {
                    const response = await fetch(`${this.baseURL}/items?language=${language}`);
                    const items = await response.json();
                    this.cache.set(cacheKey, items);
                    return items;
                } catch (error) {
                    console.error('Failed to fetch items:', error);
                    return [];
                }
            }

            getImageURL(imageName) {
                if (!imageName) return null;
                return `${this.cdnURL}/${imageName}`;
            }

            getLocalizedName(item, language = 'en') {
                if (item.localizedName && item.localizedName[language]) {
                    return item.localizedName[language];
                }
                return item.name || 'Unknown';
            }

            filterByCategory(items, category) {
                return items.filter(item => {
                    if (category === 'warframes') {
                        return item.category === 'Warframes' && !this.isCosmetic(item);
                    }
                    if (category === 'misc') {
                        return !['Warframes', 'Primary', 'Secondary', 'Melee', 'Mods', 'Arcanes'].includes(item.category);
                    }
                    return item.category === this.capitalizeFirst(category) && !this.isCosmetic(item);
                });
            }

            isCosmetic(item) {
                const cosmeticKeywords = ['Skin', 'Syandana', 'Sigil', 'Ephemera', 'Armor', 'Helmet'];
                return cosmeticKeywords.some(keyword => 
                    item.name?.includes(keyword) || 
                    item.type?.includes(keyword) ||
                    item.productCategory?.includes(keyword)
                );
            }

            capitalizeFirst(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }
        }

        // Initialize API
        const api = new WarframeAPI();

        // Number formatting with scientific notation
        function formatLargeNumber(num) {
            if (num < 1000) return num.toString();
            if (num < 1000000) return (num / 1000).toFixed(1) + 'K';
            if (num < 1000000000) return (num / 1000000).toFixed(1) + 'M';
            if (num < 1000000000000) return (num / 1000000000).toFixed(1) + 'B';
            if (num < 1000000000000000) return (num / 1000000000000).toFixed(1) + 'T';
            
            // Scientific notation for very large numbers
            const exponent = Math.floor(Math.log10(num));
            const mantissa = (num / Math.pow(10, exponent)).toFixed(2);
            return `${mantissa}e${exponent}`;
        }

        // Generate random seed
        function generateRandomSeed() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        // Calculate total combinations
        function calculateTotalCombinations() {
            const warframes = allItems.filter(item => api.filterByCategory([item], 'warframes').length > 0).length;
            const weapons = allItems.filter(item => 
                ['Primary', 'Secondary', 'Melee'].includes(item.category) && !api.isCosmetic(item)
            ).length;
            const mods = allItems.filter(item => item.category === 'Mods' && !api.isCosmetic(item)).length;
            
            // Simplified calculation: Warframes × Weapons³ × Mods⁸ (8 mod slots)
            const combinations = warframes * Math.pow(weapons, 3) * Math.pow(mods, 8);
            return combinations;
        }

        // Update ETA display
        function updateETA() {
            if (!isOptimizing || testedCombinations === 0) {
                document.getElementById('etaDisplay').textContent = '--:--:--';
                return;
            }

            const elapsed = Date.now() - optimizationStartTime;
            const rate = testedCombinations / (elapsed / 1000); // combinations per second
            const remaining = totalCombinations - testedCombinations;
            const etaSeconds = remaining / rate;

            const hours = Math.floor(etaSeconds / 3600);
            const minutes = Math.floor((etaSeconds % 3600) / 60);
            const seconds = Math.floor(etaSeconds % 60);

            document.getElementById('etaDisplay').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Theme management
        function setTheme(theme) {
            currentTheme = theme;
            document.body.className = theme + '-mode';
            localStorage.setItem('warframe-theme', theme);
            
            if (theme === 'dark') {
                document.getElementById('darkTheme').checked = true;
            } else {
                document.getElementById('lightTheme').checked = true;
            }
        }

        // Language management
        async function setLanguage(language) {
            currentLanguage = language;
            localStorage.setItem('warframe-language', language);
            try {
                await loadTranslations(language);
            } catch (e) {
                console.error('Could not load language file for', language, e);
                // Fallback anglais
                try {
                    await loadTranslations('en');
                } catch (e2) {
                    console.error('Could not load fallback English language file', e2);
                }
            }
            updateStaticTexts();
            updateSelectOptions();
            if (typeof currentCategory === 'string') {
                loadCategory(currentCategory);
            }
            loadItems(); // Recharge les items dans la bonne langue
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.remove('hidden');
            
            // Add active class to selected button
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        // Load and display items
        async function loadItems() {
            try {
                document.getElementById('loadingSpinner').classList.remove('hidden');
                allItems = await api.fetchAllItems(currentLanguage);
                
                // Update category counts
                updateCategoryCounts();
                
                // Load default category
                loadCategory('warframes');
                
                // Calculate total combinations
                totalCombinations = calculateTotalCombinations();
                document.getElementById('totalCombinations').textContent = formatLargeNumber(totalCombinations);
                
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
            } catch (error) {
                console.error('Failed to load items:', error);
            } finally {
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        }

        // Update category counts
        function updateCategoryCounts() {
            const categories = ['warframes', 'primary', 'secondary', 'melee', 'mods', 'arcanes', 'misc'];
            categories.forEach(category => {
                const count = api.filterByCategory(allItems, category).length;
                const element = document.getElementById(`${category}-count`);
                if (element) {
                    element.textContent = count;
                }
            });
        }

        // Load category
        function loadCategory(category) {
            currentCategory = category;
            currentItems = api.filterByCategory(allItems, category);
            displayedItems = 0;
            // Titre traduit + tooltip
            const titleKey = 'category_' + category;
            const title = (currentTranslations && currentTranslations[titleKey]) ? currentTranslations[titleKey] : api.capitalizeFirst(category);
            const titleEl = document.getElementById('currentCategoryTitle');
            if (titleEl) {
                titleEl.textContent = title;
                titleEl.setAttribute('data-i18n-title', titleKey);
                titleEl.title = title; // fallback immédiat
            }
            // Clear container
            document.getElementById('itemsContainer').innerHTML = '';
            // Load first batch
            loadMoreItems();
            // Update active category button
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('bg-accent', 'text-white');
                btn.classList.add('hover:bg-tertiary');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('bg-accent', 'text-white');
            // Met à jour les tooltips et textes statiques après changement de catégorie
            updateStaticTexts();
        }

        // Load more items (infinite scroll)
        function loadMoreItems() {
            const container = document.getElementById('itemsContainer');
            const itemsToLoad = currentItems.slice(displayedItems, displayedItems + itemsPerPage);
            
            itemsToLoad.forEach(item => {
                const itemElement = createItemElement(item);
                container.appendChild(itemElement);
            });
            
            displayedItems += itemsToLoad.length;
        }

        // Create item element
        function createItemElement(item) {
            const div = document.createElement('div');
            div.className = 'item-card rounded-lg p-4 cursor-pointer';
            
            const imageUrl = api.getImageURL(item.imageName);
            const itemName = api.getLocalizedName(item, currentLanguage);
            
            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-lg overflow-hidden flex-shrink-0">
                        ${imageUrl ? 
                            `<img src="${imageUrl}" alt="${itemName}" class="w-full h-full object-cover" onerror="this.parentElement.innerHTML='<div class=\\'placeholder-image w-full h-full\\'>?</div>'">` :
                            `<div class="placeholder-image w-full h-full"><i class="fas fa-question"></i></div>`
                        }
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold truncate">${itemName}</h3>
                        <p class="text-sm text-secondary">${item.type || item.category || 'Unknown'}</p>
                        ${item.masteryReq ? `<p class="text-xs text-secondary">MR: ${item.masteryReq}</p>` : ''}
                    </div>
                </div>
            `;
            
            return div;
        }

        // Optimization simulation
        function startOptimization() {
            if (isOptimizing) return;
            
            isOptimizing = true;
            optimizationStartTime = Date.now();
            testedCombinations = 0;
            
            document.getElementById('startOptimization').disabled = true;
            document.getElementById('startOptimization').innerHTML = '<i class="fas fa-pause mr-2"></i>Optimizing...';
            
            // Simulate optimization progress
            const interval = setInterval(() => {
                if (!isOptimizing) {
                    clearInterval(interval);
                    return;
                }
                
                // Simulate testing combinations
                const increment = Math.floor(Math.random() * 10000) + 1000;
                testedCombinations += increment;
                
                if (testedCombinations >= totalCombinations) {
                    testedCombinations = totalCombinations;
                    stopOptimization();
                }
                
                // Update displays
                document.getElementById('testedCombinations').textContent = formatLargeNumber(testedCombinations);
                
                const progress = (testedCombinations / totalCombinations) * 100;
                document.getElementById('progressBar').style.width = `${Math.min(progress, 100)}%`;
                document.getElementById('progressPercent').textContent = `${Math.min(progress, 100).toFixed(2)}%`;
                
                updateETA();
                
            }, 100);
        }

        function stopOptimization() {
            isOptimizing = false;
            document.getElementById('startOptimization').disabled = false;
            document.getElementById('startOptimization').innerHTML = '<i class="fas fa-play mr-2"></i>Start Optimization';
            
            // Show results
            showOptimizationResults();
        }

        function showOptimizationResults() {
            const resultsContainer = document.getElementById('optimizationResults');
            resultsContainer.innerHTML = `
                <div class="bg-tertiary rounded-lg p-6">
                    <h3 class="text-lg font-bold text-primary mb-4">🏆 Optimal Build Found</h3>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold">Warframe: Saryn Prime</h4>
                            <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                <div>• Vitality (Rank 10)</div>
                                <div>• Steel Fiber (Rank 10)</div>
                                <div>• Intensify (Rank 5)</div>
                                <div>• Stretch (Rank 5)</div>
                                <div>• Streamline (Rank 5)</div>
                                <div>• Hunter Adrenaline</div>
                                <div>• Adaptation</div>
                                <div>• Regenerative Molt</div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold">Primary: Kuva Sobek (Toxin)</h4>
                            <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                <div>• Serration (Rank 10)</div>
                                <div>• Split Chamber (Rank 5)</div>
                                <div>• Point Strike (Rank 5)</div>
                                <div>• Vital Sense (Rank 5)</div>
                                <div>• Rime Rounds (Rank 5)</div>
                                <div>• Malignant Force (Rank 3)</div>
                                <div>• Blaze (Rank 5)</div>
                                <div>• Vigilante Armaments</div>
                            </div>
                        </div>
                        <div class="bg-secondary rounded p-4">
                            <div class="flex justify-between items-center">
                                <span>Optimization Score:</span>
                                <span class="font-bold text-accent">98.7%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span>Expected DPS:</span>
                                <span class="font-bold">2,847,291</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span>EHP:</span>
                                <span class="font-bold">847,392</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Parallel search with JSON export
        function startParallelSearch() {
            const data = {
                timestamp: new Date().toISOString(),
                totalCombinations: totalCombinations,
                testedCombinations: testedCombinations,
                top100Builds: []
            };

            // Generate sample top 100 builds
            for (let i = 1; i <= 100; i++) {
                data.top100Builds.push({
                    rank: i,
                    score: (100 - i + Math.random()).toFixed(1),
                    warframe: "Saryn Prime",
                    primary: "Kuva Sobek",
                    secondary: "Kuva Nukor", 
                    melee: "Kronen Prime",
                    contentType: document.getElementById('contentType').value,
                    seed: document.getElementById('optimizationSeed').value || generateRandomSeed()
                });
            }

            // Create and download JSON file
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `warframe-top100-builds-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('Top 100 builds exported successfully!');
        }

        // Search functionality
        function filterItems() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (!searchTerm) {
                loadCategory(currentCategory);
                return;
            }

            currentItems = api.filterByCategory(allItems, currentCategory).filter(item => {
                const name = api.getLocalizedName(item, currentLanguage).toLowerCase();
                return name.includes(searchTerm);
            });

            displayedItems = 0;
            document.getElementById('itemsContainer').innerHTML = '';
            loadMoreItems();
        }

        // Intersection Observer for infinite scroll
        function setupInfiniteScroll() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && displayedItems < currentItems.length) {
                        loadMoreItems();
                    }
                });
            });

            observer.observe(document.getElementById('loadMoreTrigger'));
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Attach all listeners IMMEDIATELY (UI always interactive)
            const savedTheme = localStorage.getItem('warframe-theme') || 'light';
            const savedLanguage = localStorage.getItem('warframe-language') || 'en';
            setTheme(savedTheme);
            document.getElementById('languageSelect').value = savedLanguage;

            // Tab navigation
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    showTab(button.getAttribute('data-tab'));
                });
            });
            // Category navigation
            document.querySelectorAll('.category-btn').forEach(button => {
                button.addEventListener('click', () => {
                    loadCategory(button.getAttribute('data-category'));
                });
            });
            // Theme toggles
            document.getElementById('lightTheme').addEventListener('change', () => {
                if (document.getElementById('lightTheme').checked) {
                    setTheme('light');
                }
            });
            document.getElementById('darkTheme').addEventListener('change', () => {
                if (document.getElementById('darkTheme').checked) {
                    setTheme('dark');
                }
            });
            // Language selector (async)
            document.getElementById('languageSelect').addEventListener('change', async (e) => {
                setLanguage(e.target.value);
            });
            // Search input
            document.getElementById('searchInput').addEventListener('input', filterItems);
            // Enemy level slider
            document.getElementById('enemyLevel').addEventListener('input', (e) => {
                document.getElementById('enemyLevelDisplay').textContent = `Level: ${e.target.value}`;
            });
            // Random seed button
            document.getElementById('randomSeed').addEventListener('click', () => {
                document.getElementById('optimizationSeed').value = generateRandomSeed();
            });
            // Optimization buttons
            document.getElementById('startOptimization').addEventListener('click', startOptimization);
            document.getElementById('parallelSearch').addEventListener('click', startParallelSearch);
            // Refresh data button
            document.getElementById('refreshData').addEventListener('click', loadItems);
            // Setup infinite scroll
            setupInfiniteScroll();
            // Load initial data
            loadItems();
            // Generate initial seed
            document.getElementById('optimizationSeed').value = generateRandomSeed();
            // Start language loading (asynchronous, does not block UI)
            setLanguage(savedLanguage);
        });

        // Ajoute une fonction pour remplir dynamiquement les options de select selon la langue
        function updateSelectOptions() {
            // Content Type
            const contentTypeSelect = document.getElementById('contentType');
            if (contentTypeSelect) {
                contentTypeSelect.innerHTML = '';
                const contentTypes = [
                    { value: 'steel-path', key: 'steel-path' },
                    { value: 'eso', key: 'eso' },
                    { value: 'arbitration', key: 'arbitration' },
                    { value: 'archon-hunt', key: 'archon-hunt' },
                    { value: 'general', key: 'general' }
                ];
                contentTypes.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = currentTranslations && currentTranslations[opt.key] ? currentTranslations[opt.key] : opt.value;
                    contentTypeSelect.appendChild(option);
                });
            }
            // Target Faction
            const targetFactionSelect = document.getElementById('targetFaction');
            if (targetFactionSelect) {
                targetFactionSelect.innerHTML = '';
                const factions = [
                    { value: 'grineer', key: 'grineer' },
                    { value: 'corpus', key: 'corpus' },
                    { value: 'infested', key: 'infested' },
                    { value: 'sentient', key: 'sentient' },
                    { value: 'corrupted', key: 'corrupted' }
                ];
                factions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = currentTranslations && currentTranslations[opt.key] ? currentTranslations[opt.key] : opt.value;
                    targetFactionSelect.appendChild(option);
                });
            }
        }
    </script>
</body>
</html>